name: GHA_Lab_02_Secrets_Terraform Deployment with Github

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  Deploy_SG:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./terraform-sg
    env:
      TF_BACKEND_CONFIG: -backend-config="bucket=${AWS_BUCKET_NAME}" -backend-config="key=${AWS_BUCKET_KEY_NAME}" -backend-config="region=${AWS_REGION}"
      TF_WORKING_DIR: ./terraform-sg
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region:  ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init #${{ env.TF_BACKEND_CONFIG }}, This is not pulling state file. (Check?)

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: terraform plan

      - name: Terraform Apply
        run: terraform apply -auto-approve

      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
    
      - name: Run TFLint
        run: tflint --disable-rule=terraform_required_providers --recursive
  
      - name: Run Checkov (Security Scan)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: true
          soft_fail: true

  # Job02:
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       shell: bash
  #       working-directory: ./terraform-sg
  #   env:
  #     TF_BACKEND_CONFIG: -backend-config="bucket=${AWS_BUCKET_NAME}" -backend-config="key=${AWS_BUCKET_KEY_NAME}" -backend-config="region=${AWS_REGION}"
  #     TF_WORKING_DIR: ./terraform-sg
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Configure AWS credentials via OIDC
  #       uses: aws-actions/configure-aws-credentials@v2
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE }}
  #         aws-region:  ${{ secrets.AWS_REGION }}

  #     - name: Install TFLint
  #       run: |
  #         curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
    
  #     - name: Run TFLint
  #       run: tflint --recursive
  
  #     - name: Run Checkov (Security Scan)
  #       uses: bridgecrewio/checkov-action@master
  #       with:
  #         directory: .
  #         quiet: true
  #         soft_fail: true

  #     - name: Terraform Validate
  #       id: validate
  #       run: terraform validate -no-color

  #     - name: Terraform Plan
  #       run: terraform plan